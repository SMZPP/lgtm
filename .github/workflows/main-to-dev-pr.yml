name: Auto PR main to dev

on:
  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushï¼ˆãƒãƒ¼ã‚¸ã‚’å«ã‚€ï¼‰ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ã™ã‚‹
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  create_pr:
    # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’GitHub Actionsã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä»®æƒ³ç’°å¢ƒã§å®Ÿè¡Œ
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4
        with:
          # ghã‚³ãƒãƒ³ãƒ‰ã§PRã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã¯ã€å±¥æ­´ã®å–å¾—ã¯ä¸è¦ãªã®ã§æµ…ã„ã‚¯ãƒ­ãƒ¼ãƒ³ã§OK
          fetch-depth: 0

      - name: âš™ï¸ Setup GitHub CLI
        run: echo "GitHub CLI is already available on this runner."
        # GitHub CLIã¯ã»ã¨ã‚“ã©ã®ãƒ©ãƒ³ãƒŠãƒ¼ã«ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ãŒã€æ˜ç¤ºçš„ã«è¨­å®šã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã¯ä¸è¦ã§ã™ã€‚
        # ã“ã“ã§ã¯ã€ghã‚³ãƒãƒ³ãƒ‰ãŒåˆ©ç”¨å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã¨è¦‹ãªã—ã¦ãã ã•ã„ã€‚

      - name: ğŸ¤– Create Pull Request from main to dev
        env:
          # GitHub CLIã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # **é‡è¦**ï¼šç›´å‰ã®ã‚³ãƒŸãƒƒãƒˆãŒãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
          # ã“ã‚Œã«ã‚ˆã‚Šã€é–‹ç™ºè€…ãŒmainã«ç›´æ¥ã‚³ãƒŸãƒƒãƒˆã—ãŸå ´åˆã®PRä½œæˆã‚’é˜²ãã¾ã™ã€‚
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          if [[ $COMMIT_MESSAGE != Merge* ]]; then
            echo "Skipping: Last commit was not a merge commit."
            exit 0
          fi
          
          echo "Creating PR from main to dev..."
          
          # gh pr createã‚³ãƒãƒ³ãƒ‰ã§PRã‚’ä½œæˆ
          # -B: ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ (ãƒãƒ¼ã‚¸å…ˆ: dev)
          # -H: ãƒ˜ãƒƒãƒ‰ãƒ–ãƒ©ãƒ³ãƒ (ãƒãƒ¼ã‚¸å…ƒ: main)
          # -t: PRã®ã‚¿ã‚¤ãƒˆãƒ«
          # -b: PRã®æœ¬æ–‡
          # --assignee: PRã®æ‹…å½“è€…ã¨ã—ã¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œè€…ã‚’è‡ªå‹•è¨­å®š
          gh pr create \
            --base dev \
            --head main \
            --title "âœ¨ [Automated] Merge main into dev after feature deployment" \
            --body "ä»–ã®ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®å¤‰æ›´ãŒ main ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚ç¢ºèªå¾Œã€devãƒ–ãƒ©ãƒ³ãƒã¸ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚" \
            --assignee "${{ github.actor }}"
          
          echo "Pull Request successfully created."
